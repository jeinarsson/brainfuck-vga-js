 <!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Brainfuck VGA</title>
<style>
#mode13h {
	width: 640px;
	height:400px;
}
#code {
	width:640px;
	height:300px;
}
</style>
</head>

<body>
<p id=status>Welcome</p>
<canvas width="320" height="200" id="mode13h"></canvas>
<form><textarea id="code">...</textarea></form>

<script language="javascript">

// raw pal from DOSBox source code
var	rawpal=[0xff000000, 0xff00002a, 0xff002a00, 0xff002a2a, 0xff2a0000, 0xff2a002a, 0xff2a1500, 0xff2a2a2a, 0xff151515, 0xff15153f, 0xff153f15, 0xff153f3f, 0xff3f1515, 0xff3f153f, 0xff3f3f15, 0xff3f3f3f, 0xff000000, 0xff050505, 0xff080808, 0xff0b0b0b, 0xff0e0e0e, 0xff111111, 0xff141414, 0xff181818, 0xff1c1c1c, 0xff202020, 0xff242424, 0xff282828, 0xff2d2d2d, 0xff323232, 0xff383838, 0xff3f3f3f, 0xff00003f, 0xff10003f, 0xff1f003f, 0xff2f003f, 0xff3f003f, 0xff3f002f, 0xff3f001f, 0xff3f0010, 0xff3f0000, 0xff3f1000, 0xff3f1f00, 0xff3f2f00, 0xff3f3f00, 0xff2f3f00, 0xff1f3f00, 0xff103f00, 0xff003f00, 0xff003f10, 0xff003f1f, 0xff003f2f, 0xff003f3f, 0xff002f3f, 0xff001f3f, 0xff00103f, 0xff1f1f3f, 0xff271f3f, 0xff2f1f3f, 0xff371f3f, 0xff3f1f3f, 0xff3f1f37, 0xff3f1f2f, 0xff3f1f27, 0xff3f1f1f, 0xff3f271f, 0xff3f2f1f, 0xff3f371f, 0xff3f3f1f, 0xff373f1f, 0xff2f3f1f, 0xff273f1f, 0xff1f3f1f, 0xff1f3f27, 0xff1f3f2f, 0xff1f3f37, 0xff1f3f3f, 0xff1f373f, 0xff1f2f3f, 0xff1f273f, 0xff2d2d3f, 0xff312d3f, 0xff362d3f, 0xff3a2d3f, 0xff3f2d3f, 0xff3f2d3a, 0xff3f2d36, 0xff3f2d31, 0xff3f2d2d, 0xff3f312d, 0xff3f362d, 0xff3f3a2d, 0xff3f3f2d, 0xff3a3f2d, 0xff363f2d, 0xff313f2d, 0xff2d3f2d, 0xff2d3f31, 0xff2d3f36, 0xff2d3f3a, 0xff2d3f3f, 0xff2d3a3f, 0xff2d363f, 0xff2d313f, 0xff00001c, 0xff07001c, 0xff0e001c, 0xff15001c, 0xff1c001c, 0xff1c0015, 0xff1c000e, 0xff1c0007, 0xff1c0000, 0xff1c0700, 0xff1c0e00, 0xff1c1500, 0xff1c1c00, 0xff151c00, 0xff0e1c00, 0xff071c00, 0xff001c00, 0xff001c07, 0xff001c0e, 0xff001c15, 0xff001c1c, 0xff00151c, 0xff000e1c, 0xff00071c, 0xff0e0e1c, 0xff110e1c, 0xff150e1c, 0xff180e1c, 0xff1c0e1c, 0xff1c0e18, 0xff1c0e15, 0xff1c0e11, 0xff1c0e0e, 0xff1c110e, 0xff1c150e, 0xff1c180e, 0xff1c1c0e, 0xff181c0e, 0xff151c0e, 0xff111c0e, 0xff0e1c0e, 0xff0e1c11, 0xff0e1c15, 0xff0e1c18, 0xff0e1c1c, 0xff0e181c, 0xff0e151c, 0xff0e111c, 0xff14141c, 0xff16141c, 0xff18141c, 0xff1a141c, 0xff1c141c, 0xff1c141a, 0xff1c1418, 0xff1c1416, 0xff1c1414, 0xff1c1614, 0xff1c1814, 0xff1c1a14, 0xff1c1c14, 0xff1a1c14, 0xff181c14, 0xff161c14, 0xff141c14, 0xff141c16, 0xff141c18, 0xff141c1a, 0xff141c1c, 0xff141a1c, 0xff14181c, 0xff14161c, 0xff000010, 0xff040010, 0xff080010, 0xff0c0010, 0xff100010, 0xff10000c, 0xff100008, 0xff100004, 0xff100000, 0xff100400, 0xff100800, 0xff100c00, 0xff101000, 0xff0c1000, 0xff081000, 0xff041000, 0xff001000, 0xff001004, 0xff001008, 0xff00100c, 0xff001010, 0xff000c10, 0xff000810, 0xff000410, 0xff080810, 0xff0a0810, 0xff0c0810, 0xff0e0810, 0xff100810, 0xff10080e, 0xff10080c, 0xff10080a, 0xff100808, 0xff100a08, 0xff100c08, 0xff100e08, 0xff101008, 0xff0e1008, 0xff0c1008, 0xff0a1008, 0xff081008, 0xff08100a, 0xff08100c, 0xff08100e, 0xff081010, 0xff080e10, 0xff080c10, 0xff080a10, 0xff0b0b10, 0xff0c0b10, 0xff0d0b10, 0xff0f0b10, 0xff100b10, 0xff100b0f, 0xff100b0d, 0xff100b0c, 0xff100b0b, 0xff100c0b, 0xff100d0b, 0xff100f0b, 0xff10100b, 0xff0f100b, 0xff0d100b, 0xff0c100b, 0xff0b100b, 0xff0b100c, 0xff0b100d, 0xff0b100f, 0xff0b1010, 0xff0b0f10, 0xff0b0d10, 0xff0b0c10, 0xff000000, 0xff000000, 0xff000000, 0xff000000, 0xff000000, 0xff000000, 0xff000000, 0xff000000];

// converted to argb
var pal = [0xff000000,0xff0000aa,0xff00aa00,0xff00aaaa,0xffaa0000,0xffaa00aa,0xffaa5500,0xffaaaaaa,0xff555555,0xff5555ff,0xff55ff55,0xff55ffff,0xffff5555,0xffff55ff,0xffffff55,0xffffffff,0xff000000,0xff141414,0xff202020,0xff2c2c2c,0xff383838,0xff454545,0xff515151,0xff616161,0xff717171,0xff828282,0xff929292,0xffa2a2a2,0xffb6b6b6,0xffcbcbcb,0xffe3e3e3,0xffffffff,0xff0000ff,0xff4100ff,0xff7d00ff,0xffbe00ff,0xffff00ff,0xffff00be,0xffff007d,0xffff0041,0xffff0000,0xffff4100,0xffff7d00,0xffffbe00,0xffffff00,0xffbeff00,0xff7dff00,0xff41ff00,0xff00ff00,0xff00ff41,0xff00ff7d,0xff00ffbe,0xff00ffff,0xff00beff,0xff007dff,0xff0041ff,0xff7d7dff,0xff9e7dff,0xffbe7dff,0xffdf7dff,0xffff7dff,0xffff7ddf,0xffff7dbe,0xffff7d9e,0xffff7d7d,0xffff9e7d,0xffffbe7d,0xffffdf7d,0xffffff7d,0xffdfff7d,0xffbeff7d,0xff9eff7d,0xff7dff7d,0xff7dff9e,0xff7dffbe,0xff7dffdf,0xff7dffff,0xff7ddfff,0xff7dbeff,0xff7d9eff,0xffb6b6ff,0xffc7b6ff,0xffdbb6ff,0xffebb6ff,0xffffb6ff,0xffffb6eb,0xffffb6db,0xffffb6c7,0xffffb6b6,0xffffc7b6,0xffffdbb6,0xffffebb6,0xffffffb6,0xffebffb6,0xffdbffb6,0xffc7ffb6,0xffb6ffb6,0xffb6ffc7,0xffb6ffdb,0xffb6ffeb,0xffb6ffff,0xffb6ebff,0xffb6dbff,0xffb6c7ff,0xff000071,0xff1c0071,0xff380071,0xff550071,0xff710071,0xff710055,0xff710038,0xff71001c,0xff710000,0xff711c00,0xff713800,0xff715500,0xff717100,0xff557100,0xff387100,0xff1c7100,0xff007100,0xff00711c,0xff007138,0xff007155,0xff007171,0xff005571,0xff003871,0xff001c71,0xff383871,0xff453871,0xff553871,0xff613871,0xff713871,0xff713861,0xff713855,0xff713845,0xff713838,0xff714538,0xff715538,0xff716138,0xff717138,0xff617138,0xff557138,0xff457138,0xff387138,0xff387145,0xff387155,0xff387161,0xff387171,0xff386171,0xff385571,0xff384571,0xff515171,0xff595171,0xff615171,0xff695171,0xff715171,0xff715169,0xff715161,0xff715159,0xff715151,0xff715951,0xff716151,0xff716951,0xff717151,0xff697151,0xff617151,0xff597151,0xff517151,0xff517159,0xff517161,0xff517169,0xff517171,0xff516971,0xff516171,0xff515971,0xff000041,0xff100041,0xff200041,0xff300041,0xff410041,0xff410030,0xff410020,0xff410010,0xff410000,0xff411000,0xff412000,0xff413000,0xff414100,0xff304100,0xff204100,0xff104100,0xff004100,0xff004110,0xff004120,0xff004130,0xff004141,0xff003041,0xff002041,0xff001041,0xff202041,0xff282041,0xff302041,0xff382041,0xff412041,0xff412038,0xff412030,0xff412028,0xff412020,0xff412820,0xff413020,0xff413820,0xff414120,0xff384120,0xff304120,0xff284120,0xff204120,0xff204128,0xff204130,0xff204138,0xff204141,0xff203841,0xff203041,0xff202841,0xff2c2c41,0xff302c41,0xff342c41,0xff3c2c41,0xff412c41,0xff412c3c,0xff412c34,0xff412c30,0xff412c2c,0xff41302c,0xff41342c,0xff413c2c,0xff41412c,0xff3c412c,0xff34412c,0xff30412c,0xff2c412c,0xff2c4130,0xff2c4134,0xff2c413c,0xff2c4141,0xff2c3c41,0xff2c3441,0xff2c3041,0xff000000,0xff000000,0xff000000,0xff000000,0xff000000,0xff000000,0xff000000,0xff000000];


let canvas = document.getElementById('mode13h');
let codebox = document.getElementById('code');
let statusP = document.getElementById('status')
const width = canvas.width;
const height = canvas.height;

let ctx = canvas.getContext('2d');
let imageData = ctx.getImageData(0, 0, width, height);
var buf = new ArrayBuffer(imageData.data.length);
var buf8 = new Uint8ClampedArray(buf);
var pixels = new Uint32Array(buf);

var ptr = 0;
const nPixels = width * height;
const nColors = pal.length;
var mem = new Uint8Array(nPixels);


var timer = null;
var delay = 1000;

codebox.onkeypress = function() {
	if (timer) {
		clearTimeout(timer);
		timer = null;
	}

	timer = setTimeout(start, delay)
}

const speed = 1000; // instructions per millisecond


var ptr = 0;
var pc = 0;
var loopStack = [];
var code = '';
function start() {

	timer = null;
	code = codebox.value;
	pixels.fill(pal[0]);
	mem.fill(0);
	ptr = 0;
	pc = 0;
	loopStack = [];

	statusP.innerHTML = 'Program started.'
	
	lastTime = null;
	tick();

}

var lastTime = null;
function tick(t) {
	if (null === lastTime) {
		lastTime = t;
		window.requestAnimationFrame(tick);
		return;
	}

	const dt = t - lastTime;
	lastTime = t;

	let nOps = Math.round(speed * dt);

	let result = interpret(nOps);
	draw();

	if (!result) {
		statusP.innerHTML = 'Program end.'
	} else {
		statusP.innerHTML = 'Program running.'
		window.requestAnimationFrame(tick);
	}

}

function interpret(n) {

	let remaining = n;
	while(pc < code.length && remaining--) {

		let c = code.charAt(pc)

		switch(c) {
			case '>':
				ptr++;
				if (ptr == nPixels) ptr = 0;
				break;
			case '<':
				ptr--;
				if (ptr === -1) ptr = nPixels-1;
				break;
			case '+':
				mem[ptr]++;
				if (mem[ptr] == nColors) mem[ptr] = 0;
				pixels[ptr] = pal[mem[ptr]];
				break;
			case '-':
				mem[ptr]--;
				if (mem[ptr] === -1) mem[ptr] = nColors-1;
				pixels[ptr] = pal[mem[ptr]];
				break;
			case '.':
				break;
			case ',':
				break;
			case '[':
				if (mem[ptr]===0) { // skip to matching ]

					let nOpen = 0;
					while(pc < code.length-1) {
						pc++;
						let c2 = code.charAt(pc);
						if (c2 === '[') {
							nOpen++;
							continue;
						}
						if (c2 === ']') {
							if (nOpen === 0) {
								break;
							} else {
								nOpen--;
								continue;
							}
						}
					}

				} else {
					loopStack.push(pc)
				} 
				break;
			case ']':
				if (mem[ptr]!=0) {
					pc = loopStack.pop()-1; //-1 because pc is increased below
				}
				break;
		}
		pc++;
	}

	return (pc < code.length);

}

function draw() {
	imageData.data.set(buf8)
	ctx.putImageData(imageData, 0, 0);
}

start();

</script>
</body>

</html> 